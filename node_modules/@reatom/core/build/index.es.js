function n(n,t){return{state:n,stateNew:{},type:t.type,payload:t.payload,changedIds:[]}}var t=function(){function n(){this._counter=new Map}var t=n.prototype;return t.add=function(n){this._counter.set(n,(this._counter.get(n)||0)+1)},t.delete=function(n){var t=this._counter.get(n);return 1===t?this._counter.delete(n):(t>1&&this._counter.set(n,t-1),!1)},t.forEach=function(n){this._counter.forEach(function(t,e){return n(e)})},n}(),e=function(){function n(n,t){void 0===t&&(t=!1),this.id=n,this.isLeaf=t,this.fnsMap=new Map}var e=n.prototype;return e._getFns=function(n){return this.fnsMap.get(n)||this.fnsMap.set(n,new t).get(n)},e.addFn=function(n,t){this._getFns(t).add(n)},e.union=function(n){var t=this;n.fnsMap.forEach(function(n,e){var r=t._getFns(e);n.forEach(function(n){return r.add(n)})})},e.disunion=function(n,t){var e=this;n.fnsMap.forEach(function(n,r){var i=e._getFns(r);n.forEach(function(n){return i.delete(n)&&t(n._ownerAtomId)})})},e.forEach=function(n,t){var e=this.fnsMap.get(n);e&&e.forEach(function(n){return n(t)})},n}(),r=Symbol("@@Reatom/TREE");function i(){}var o=Object.assign,a=Object.is;function u(n){return n&&n[r]}function c(n){return"symbol"==typeof n?n.description||n.toString().replace(/Symbol\((.*)\)/,"$1"):n}function f(n){var t=u(n);return Boolean(t&&!t.isLeaf)}function s(n){var t=u(n);return Boolean(t&&t.isLeaf)}var d,v=0;function l(n){return"symbol"==typeof n?n:Array.isArray(n)?g(n[0],"name"):g(n,"name")+" ["+ ++v+"]"}function p(n){return d?d(n):l(n)}function h(n){d=m(n,"gen")}function y(n){throw new Error("[reatom] "+n)}function g(n,t){return"string"==typeof n&&0!==n.length||y("Invalid "+t),n}function m(n,t){return"function"!=typeof n&&y("Invalid "+t),n}function w(n){var t=Object.keys(n);return t.push.apply(t,Object.getOwnPropertySymbols(n)),t}function b(n){void 0===n&&(n="action");var t=[].slice.call(arguments,1);"function"==typeof n&&(t.unshift(n),n="action");var i=p(n),o=new e(i,!0),a=function(n){return{type:i,payload:n,reactions:t}};return a[r]=o,a.getType=function(){return i},a}var E=Symbol("@@Reatom/DEPS"),I=Symbol("@@Reatom/DEPS_SHAPE"),S=b(["@@Reatom/init"]),_=S();function M(t,i,f){f||(f=i,i=t,t="atom");var d=p(t),v=c(d);void 0===i&&y('Atom "'+v+"\". Initial state can't be undefined");var l=new e(d),h=new Set,g=0;function w(n,t){m(t,"reducer");var e=g++,r=u(n);r||y("Invalid dependency");var i=r.id,o=s(n);l.union(r);var c=function(n){var r=n.state,u=n.stateNew,c=n.payload,f=n.changedIds,s=r[d],l=void 0===s;if(l||n.type!==_.type||c){var p=u[d],h=void 0!==p,g=h?p:s,m=u[i],w=void 0!==m;if(o||w||l){var b=t(g,o?c:w?m:r[i]);if(void 0===b&&y("Invalid state. Reducer number "+e+' in "'+v+'" atom returns undefined'),h&&a(s,b))return f.splice(f.indexOf(d),1),void delete u[d];a(g,b)||(h||f.push(d),u[d]=b)}}};if(c._ownerAtomId=d,o)return l.addFn(c,i);h.has(i)&&y("One of dependencies has the equal id"),h.add(i),r.fnsMap.forEach(function(n,t){return l.addFn(c,t)})}w(S,function(n,t){var e=(void 0===t?{}:t)[d];return void 0===e?i:e}),f(w);var b=function(t,e){void 0===t&&(t={}),void 0===e&&(e=_);var r=n(t,e);return l.forEach(e.type,r),r.changedIds.length>0?o({},t,r.stateNew):t};return b[r]=l,b[E]=h,b}function j(n,t){return n[t[r].id]}function O(n,t,e){return e||(e=t,t=n,n=Symbol(c(u(t).id)+" [map]")),m(e,"mapper"),M(n,null,function(n){return n(t,function(n,t){return e(t)})})}function A(n,t){1===arguments.length&&(t=n);var e=Array.isArray(t),r=w(t);1===arguments.length&&(n=e?Symbol("["+r.map(function(n){return c(u(t[n]).id)}).join()+"]"):Symbol("{"+r.map(c).join()+"}"));var i=M(n,e?[]:{},function(n){return r.forEach(function(r){return n(t[r],function(n,t){var i=e?n.slice(0):o({},n);return i[r]=t,i})})});return i[I]=t,i}function N(n){return n[I]}function F(t,r){var i=new Map,a=i,c=[],d=c,v=new Set,l={},p=new e("store");if(void 0!==t)if("object"==typeof t&&void 0===r)o(l,t);else{f(t)||y("Invalid atom"),"object"==typeof r&&null!==r?o(l,r):void 0!==r&&y("Invalid initial state"),p.union(u(t));var h=n(l,_);p.forEach(_.type,h),o(l,h.stateNew),v=new Set(w(h.stateNew))}function g(){d===c&&(d=c.slice())}function b(n){a===i&&(a=new Map,i.forEach(function(t,e){return a.set(e,n===e?t.slice():t)}))}var E={getState:function(t){if(void 0===t)return o({},l);f(t)||y("Invalid target");var e=j(l,t);if(void 0!==e)return e;var r=n(l,_);return u(t).forEach(_.type,r),j(r.stateNew,t)},subscribe:function(t,e){var r=m(e||t,"listener"),i=!0;if(void 0===e)return(f(r)||s(r))&&y("Invalid listener"),g(),d.push(r),function(){i&&(i=!1,g(),d.splice(d.indexOf(r),1))};var c=s(t);f(t)||c||y("Invalid subscription target");var h=u(t),w=h.id,E=!c&&!v.has(w);if(b(w),!a.has(w)&&(a.set(w,[]),E)){p.union(h);var I=n(l,_);h.forEach(_.type,I),o(l,I.stateNew)}return a.get(w).push(r),function(){if(i){i=!1,b(w);var n=a.get(w);n.splice(n.indexOf(r),1),E&&0===n.length&&(a.delete(w),p.disunion(h,function(n){delete l[n]}))}}},dispatch:function(t){var e=t.type,r=t.payload,u=t.reactions;"object"==typeof t&&null!==t&&"string"==typeof e||y("Invalid action");var f=n(l,t);p.forEach(e,f);var s=f.changedIds,v=f.stateNew;if(i=a,e===_.type&&(l=r||{}),s.length>0){o(l,v);for(var h=0;h<s.length;h++){var g=s[h];R(i.get(g)||[],v[g])}}R(u||[],r,E),R(i.get(e)||[],r),R(c=d,t,v)},bind:function(n){return function(){return E.dispatch(n.apply(void 0,[].slice.call(arguments)))}}};return E}function R(n){for(var t=-1;++t<n.length;)n[t].apply(n,[].slice.call(arguments,1))}export{A as combine,F as createStore,b as declareAction,M as declareAtom,N as getDepsShape,s as getIsAction,f as getIsAtom,j as getState,u as getTree,S as init,_ as initAction,O as map,l as nameToIdDefault,i as noop,h as setNameToId};
//# sourceMappingURL=index.es.js.map
