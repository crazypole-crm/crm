function t(t,{type:n,payload:e}){return{state:t,stateNew:{},type:n,payload:e,changedIds:[]}}class n{constructor(){this._counter=new Map}add(t){this._counter.set(t,(this._counter.get(t)||0)+1)}delete(t){const n=this._counter.get(t);return 1===n?this._counter.delete(t):(n>1&&this._counter.set(t,n-1),!1)}forEach(t){this._counter.forEach((n,e)=>t(e))}}class e{constructor(t,n=!1){this.id=t,this.isLeaf=n,this.fnsMap=new Map}_getFns(t){return this.fnsMap.get(t)||this.fnsMap.set(t,new n).get(t)}addFn(t,n){this._getFns(n).add(t)}union(t){t.fnsMap.forEach((t,n)=>{const e=this._getFns(n);t.forEach(t=>e.add(t))})}disunion(t,n){t.fnsMap.forEach((t,e)=>{const o=this._getFns(e);t.forEach(t=>o.delete(t)&&n(t._ownerAtomId))})}forEach(t,n){const e=this.fnsMap.get(t);e&&e.forEach(t=>t(n))}}const o=Symbol("@@Reatom/TREE");function i(){}const s=Object.assign,c=Object.is;function r(t){return t&&t[o]}function a(t){return"symbol"==typeof t?t.description||t.toString().replace(/Symbol\((.*)\)/,"$1"):t}function u(t){const n=r(t);return Boolean(n&&!n.isLeaf)}function f(t){const n=r(t);return Boolean(n&&n.isLeaf)}let d,l=0;function p(t){return"symbol"==typeof t?t:Array.isArray(t)?m(t[0],"name"):`${m(t,"name")} [${++l}]`}function h(t){return d?d(t):p(t)}function y(t){d=w(t,"gen")}function g(t){throw new Error("[reatom] "+t)}function m(t,n){return"string"==typeof t&&0!==t.length||g("Invalid "+n),t}function w(t,n){return"function"!=typeof t&&g("Invalid "+n),t}function b(t){const n=Object.keys(t);return n.push(...Object.getOwnPropertySymbols(t)),n}function v(t="action",...n){"function"==typeof t&&(n.unshift(t),t="action");const i=h(t),s=new e(i,!0),c=function(t){return{type:i,payload:t,reactions:n}};return c[o]=s,c.getType=()=>i,c}const E=Symbol("@@Reatom/DEPS"),I=Symbol("@@Reatom/DEPS_SHAPE"),S=v(["@@Reatom/init"]),_=S();function M(n,i,u){u||(u=i,i=n,n="atom");const d=h(n),l=a(d);void 0===i&&g(`Atom "${l}". Initial state can't be undefined`);const p=new e(d),y=new Set;let m=0;function b(t,n){w(n,"reducer");const e=m++,o=r(t);o||g("Invalid dependency");const i=o.id,s=f(t);p.union(o);const a=function({state:t,stateNew:o,payload:r,changedIds:a,type:u}){const f=t[d],p=void 0===f;if(!p&&u===_.type&&!r)return;const h=o[d],y=void 0!==h,m=y?h:f,w=o[i],b=void 0!==w;if(s||b||p){const u=n(m,s?r:b?w:t[i]);if(void 0===u&&g(`Invalid state. Reducer number ${e} in "${l}" atom returns undefined`),y&&c(f,u))return a.splice(a.indexOf(d),1),void delete o[d];c(m,u)||(y||a.push(d),o[d]=u)}};if(a._ownerAtomId=d,s)return p.addFn(a,i);y.has(i)&&g("One of dependencies has the equal id"),y.add(i),o.fnsMap.forEach((t,n)=>p.addFn(a,n))}b(S,(t,{[d]:n=i}={})=>n),u(b);const v=function(n={},e=_){const o=t(n,e);p.forEach(e.type,o);const{changedIds:i,stateNew:c}=o;return i.length>0?s({},n,c):n};return v[o]=p,v[E]=y,v}function j(t,n){return t[n[o].id]}function O(t,n,e){return e||(e=n,n=t,t=Symbol(a(r(n).id)+" [map]")),w(e,"mapper"),M(t,null,t=>t(n,(t,n)=>e(n)))}function A(t,n){1===arguments.length&&(n=t);const e=Array.isArray(n),o=b(n);1===arguments.length&&(t=e?Symbol(`[${o.map(t=>a(r(n[t]).id)).join()}]`):Symbol(`{${o.map(a).join()}}`));const i=M(t,e?[]:{},t=>o.forEach(o=>t(n[o],(t,n)=>{const i=e?t.slice(0):s({},t);return i[o]=n,i})));return i[I]=n,i}function N(t){return t[I]}function $(n,o){let i=new Map,c=i,a=[],d=a,l=new Set,p={};const h=new e("store");if(void 0!==n)if("object"==typeof n&&void 0===o)s(p,n);else{u(n)||g("Invalid atom"),"object"==typeof o&&null!==o?s(p,o):void 0!==o&&g("Invalid initial state"),h.union(r(n));const e=t(p,_);h.forEach(_.type,e),s(p,e.stateNew),l=new Set(b(e.stateNew))}function y(){d===a&&(d=a.slice())}function m(t){c===i&&(c=new Map,i.forEach((n,e)=>c.set(e,t===e?n.slice():n)))}const v={getState:function(n){if(void 0===n)return s({},p);u(n)||g("Invalid target");const e=j(p,n);if(void 0!==e)return e;const o=t(p,_);return r(n).forEach(_.type,o),j(o.stateNew,n)},subscribe:function(n,e){const o=w(e||n,"listener");let i=!0;if(void 0===e)return(u(o)||f(o))&&g("Invalid listener"),y(),d.push(o),()=>{i&&(i=!1,y(),d.splice(d.indexOf(o),1))};const a=f(n);u(n)||a||g("Invalid subscription target");const b=r(n),v=b.id,E=!a&&!l.has(v);if(m(v),!c.has(v)&&(c.set(v,[]),E)){h.union(b);const n=t(p,_);b.forEach(_.type,n),s(p,n.stateNew)}return c.get(v).push(o),()=>{if(!i)return;i=!1,m(v);const t=c.get(v);t.splice(t.indexOf(o),1),E&&0===t.length&&(c.delete(v),h.disunion(b,t=>{delete p[t]}))}},dispatch:function(n){const{type:e,payload:o,reactions:r}=n;"object"==typeof n&&null!==n&&"string"==typeof e||g("Invalid action");const u=t(p,n);h.forEach(e,u);const{changedIds:f,stateNew:l}=u;if(i=c,e===_.type&&(p=o||{}),f.length>0){s(p,l);for(let t=0;t<f.length;t++){const n=f[t];F(i.get(n)||[],l[n])}}F(r||[],o,v),F(i.get(e)||[],o),F(a=d,n,l)},bind:t=>(...n)=>v.dispatch(t(...n))};return v}function F(t,...n){let e=-1;for(;++e<t.length;)t[e](...n)}export{A as combine,$ as createStore,v as declareAction,M as declareAtom,N as getDepsShape,f as getIsAction,u as getIsAtom,j as getState,r as getTree,S as init,_ as initAction,O as map,p as nameToIdDefault,i as noop,y as setNameToId};
//# sourceMappingURL=index.modern.js.map
