function t(t,n){return{state:t,stateNew:{},type:n.type,payload:n.payload,changedIds:[]}}var n=function(){function t(){this._counter=new Map}var n=t.prototype;return n.add=function(t){this._counter.set(t,(this._counter.get(t)||0)+1)},n.delete=function(t){var n=this._counter.get(t);return 1===n?this._counter.delete(t):(n>1&&this._counter.set(t,n-1),!1)},n.forEach=function(t){this._counter.forEach(function(n,e){return t(e)})},t}(),e=function(){function t(t,n){void 0===n&&(n=!1),this.id=t,this.isLeaf=n,this.fnsMap=new Map}var e=t.prototype;return e._getFns=function(t){return this.fnsMap.get(t)||this.fnsMap.set(t,new n).get(t)},e.addFn=function(t,n){this._getFns(n).add(t)},e.union=function(t){var n=this;t.fnsMap.forEach(function(t,e){var r=n._getFns(e);t.forEach(function(t){return r.add(t)})})},e.disunion=function(t,n){var e=this;t.fnsMap.forEach(function(t,r){var o=e._getFns(r);t.forEach(function(t){return o.delete(t)&&n(t._ownerAtomId)})})},e.forEach=function(t,n){var e=this.fnsMap.get(t);e&&e.forEach(function(t){return t(n)})},t}(),r=Symbol("@@Reatom/TREE"),o=Object.assign,i=Object.is;function a(t){return t&&t[r]}function u(t){return"symbol"==typeof t?t.description||t.toString().replace(/Symbol\((.*)\)/,"$1"):t}function c(t){var n=a(t);return Boolean(n&&!n.isLeaf)}function f(t){var n=a(t);return Boolean(n&&n.isLeaf)}var s,d=0;function p(t){return"symbol"==typeof t?t:Array.isArray(t)?h(t[0],"name"):h(t,"name")+" ["+ ++d+"]"}function l(t){return s?s(t):p(t)}function v(t){throw new Error("[reatom] "+t)}function h(t,n){return"string"==typeof t&&0!==t.length||v("Invalid "+n),t}function y(t,n){return"function"!=typeof t&&v("Invalid "+n),t}function g(t){var n=Object.keys(t);return n.push.apply(n,Object.getOwnPropertySymbols(t)),n}function m(t){void 0===t&&(t="action");var n=[].slice.call(arguments,1);"function"==typeof t&&(n.unshift(t),t="action");var o=l(t),i=new e(o,!0),a=function(t){return{type:o,payload:t,reactions:n}};return a[r]=i,a.getType=function(){return o},a}var b=Symbol("@@Reatom/DEPS"),w=Symbol("@@Reatom/DEPS_SHAPE"),E=m(["@@Reatom/init"]),I=E();function S(n,c,s){s||(s=c,c=n,n="atom");var d=l(n),p=u(d);void 0===c&&v('Atom "'+p+"\". Initial state can't be undefined");var h=new e(d),g=new Set,m=0;function w(t,n){y(n,"reducer");var e=m++,r=a(t);r||v("Invalid dependency");var o=r.id,u=f(t);h.union(r);var c=function(t){var r=t.state,a=t.stateNew,c=t.payload,f=t.changedIds,s=r[d],l=void 0===s;if(l||t.type!==I.type||c){var h=a[d],y=void 0!==h,g=y?h:s,m=a[o],b=void 0!==m;if(u||b||l){var w=n(g,u?c:b?m:r[o]);if(void 0===w&&v("Invalid state. Reducer number "+e+' in "'+p+'" atom returns undefined'),y&&i(s,w))return f.splice(f.indexOf(d),1),void delete a[d];i(g,w)||(y||f.push(d),a[d]=w)}}};if(c._ownerAtomId=d,u)return h.addFn(c,o);g.has(o)&&v("One of dependencies has the equal id"),g.add(o),r.fnsMap.forEach(function(t,n){return h.addFn(c,n)})}w(E,function(t,n){var e=(void 0===n?{}:n)[d];return void 0===e?c:e}),s(w);var S=function(n,e){void 0===n&&(n={}),void 0===e&&(e=I);var r=t(n,e);return h.forEach(e.type,r),r.changedIds.length>0?o({},n,r.stateNew):n};return S[r]=h,S[b]=g,S}function x(t,n){return t[n[r].id]}function _(t){for(var n=-1;++n<t.length;)t[n].apply(t,[].slice.call(arguments,1))}exports.combine=function(t,n){1===arguments.length&&(n=t);var e=Array.isArray(n),r=g(n);1===arguments.length&&(t=e?Symbol("["+r.map(function(t){return u(a(n[t]).id)}).join()+"]"):Symbol("{"+r.map(u).join()+"}"));var i=S(t,e?[]:{},function(t){return r.forEach(function(r){return t(n[r],function(t,n){var i=e?t.slice(0):o({},t);return i[r]=n,i})})});return i[w]=n,i},exports.createStore=function(n,r){var i=new Map,u=i,s=[],d=s,p=new Set,l={},h=new e("store");if(void 0!==n)if("object"==typeof n&&void 0===r)o(l,n);else{c(n)||v("Invalid atom"),"object"==typeof r&&null!==r?o(l,r):void 0!==r&&v("Invalid initial state"),h.union(a(n));var m=t(l,I);h.forEach(I.type,m),o(l,m.stateNew),p=new Set(g(m.stateNew))}function b(){d===s&&(d=s.slice())}function w(t){u===i&&(u=new Map,i.forEach(function(n,e){return u.set(e,t===e?n.slice():n)}))}var E={getState:function(n){if(void 0===n)return o({},l);c(n)||v("Invalid target");var e=x(l,n);if(void 0!==e)return e;var r=t(l,I);return a(n).forEach(I.type,r),x(r.stateNew,n)},subscribe:function(n,e){var r=y(e||n,"listener"),i=!0;if(void 0===e)return(c(r)||f(r))&&v("Invalid listener"),b(),d.push(r),function(){i&&(i=!1,b(),d.splice(d.indexOf(r),1))};var s=f(n);c(n)||s||v("Invalid subscription target");var g=a(n),m=g.id,E=!s&&!p.has(m);if(w(m),!u.has(m)&&(u.set(m,[]),E)){h.union(g);var S=t(l,I);g.forEach(I.type,S),o(l,S.stateNew)}return u.get(m).push(r),function(){if(i){i=!1,w(m);var t=u.get(m);t.splice(t.indexOf(r),1),E&&0===t.length&&(u.delete(m),h.disunion(g,function(t){delete l[t]}))}}},dispatch:function(n){var e=n.type,r=n.payload,a=n.reactions;"object"==typeof n&&null!==n&&"string"==typeof e||v("Invalid action");var c=t(l,n);h.forEach(e,c);var f=c.changedIds,p=c.stateNew;if(i=u,e===I.type&&(l=r||{}),f.length>0){o(l,p);for(var y=0;y<f.length;y++){var g=f[y];_(i.get(g)||[],p[g])}}_(a||[],r,E),_(i.get(e)||[],r),_(s=d,n,p)},bind:function(t){return function(){return E.dispatch(t.apply(void 0,[].slice.call(arguments)))}}};return E},exports.declareAction=m,exports.declareAtom=S,exports.getDepsShape=function(t){return t[w]},exports.getIsAction=f,exports.getIsAtom=c,exports.getState=x,exports.getTree=a,exports.init=E,exports.initAction=I,exports.map=function(t,n,e){return e||(e=n,n=t,t=Symbol(u(a(n).id)+" [map]")),y(e,"mapper"),S(t,null,function(t){return t(n,function(t,n){return e(n)})})},exports.nameToIdDefault=p,exports.noop=function(){},exports.setNameToId=function(t){s=y(t,"gen")};
//# sourceMappingURL=index.js.map
